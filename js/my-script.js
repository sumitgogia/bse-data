const sStatusSpinner=".spinner-border[role='status']",sDateRangePicker="input.data-filter.dates",sDataTableInfoFiltersWrapper="div.data-info-filters",sCompaniesFilter="div.data-info-filters select.data-filter.companies",sDataTable="#dataTable",sDataTableInfo="#dataTable_info",sDataTableFilter="#dataTable_filter",companiesColumnIndex=0;function toggleVisibility(e){$(e).is(".visible")?makeInvisible(e):makeVisible(e)}function makeVisible(e){$(e).removeClass("invisible").addClass("visible")}function makeInvisible(e){$(e).removeClass("visible").addClass("invisible")}function createDataTable(e,a,t,n){const s=(e,a,t)=>"display"===a&&"string"==typeof e?e.replace(/\\n/g,"<br>"):e,l=e.DataTable({columns:a.map((e=>({title:e,render:s}))),data:t,searchHighlight:!0,fixedHeader:!0,deferRender:!0,scrollY:"100vh",scroller:!0,scrollCollapse:!0,searchDelay:1e3,oLanguage:{sEmptyTable:"No announcements! Pick a different date range.",sZeroRecords:"No announcements! Try changing or clearing filters."}});makeVisible(n);const i=n,o=$("#dataTable_info").detach(),r=$("#dataTable_filter").detach();return $('<div class="col-sm-auto"></div>').prependTo(i).append(r),$('<div class="col-sm-auto"></div>').appendTo(i).append(o),l.on("search.dt",(()=>{const e=l.search();e.length>3&&gtag("event","announcement_search",{query:e});const a=l.column(companiesColumnIndex).search();a.length&&a.split("|").forEach((e=>{gtag("event","company_filter",{company:e.slice(1,-1)})}))})),l}async function updateDatatable(){const e=$(sDataTable);let a=$.fn.DataTable.isDataTable(e)?e.DataTable():void 0;a&&a.clear().draw();const t={dateRange:{from:void 0,to:void 0},companies:void 0},n=$(sDateRangePicker).data("daterangepicker");t.dateRange.from=n.startDate,t.dateRange.to=n.endDate;const s=(await import("./bse-data-service.js")).default,l=await s.announcements(t);if(!l||!l.length||!l[0].values.length)return void console.warn("No announcement data found for filters: "+JSON.stringify(t));const i=l[0].columns,o=l[0].values,r=$("div.data-info-filters");a?a.rows.add(o).draw():a=createDataTable(e,i,o,r),updateCompaniesFilter()}function updateCompaniesFilter(){const e=$(sCompaniesFilter).empty(),a=$(sDataTable);if(!$.fn.DataTable.isDataTable(a))return;const t=a.DataTable().column(companiesColumnIndex).cache("search").sort().unique().map((e=>new Option(e,e,!1,!1)));e.append(t)}$(document).ready((function(){const e=$(sCompaniesFilter);e.select2({placeholder:"Select companies...",allowClear:!0,data:[],multiple:!0,width:"100%"}),e.on("change",(function(){let e=$(this).select2("data").map((e=>e.text?"^"+$.fn.dataTable.util.escapeRegex(e.text)+"$":null));0===e.length&&(e=[""]);const a=e.join("|"),t=$(sDataTable);if($.fn.DataTable.isDataTable(t)){t.DataTable().column(companiesColumnIndex).search(a,!0,!1).draw()}})),e.on("select2:clear",(function(e){$(this).on("select2:opening.cancelOpen",(function(e){e.preventDefault(),$(this).off("select2:opening.cancelOpen")}))}));const a=new Date,t=new Date(a.getFullYear(),a.getMonth()-1,1),n=(new Date(a.getFullYear(),a.getMonth()+1,0),$(sDateRangePicker));n.daterangepicker({minDate:t,maxDate:a,maxSpan:{days:7},startDate:a,endDate:a,ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()]},locale:{format:"MMMM DD, YYYY"}}).on("apply.daterangepicker",((e,a)=>{a.element.attr("size",a.element.val().length),makeVisible(sStatusSpinner),updateDatatable().then((()=>makeInvisible(sStatusSpinner)))})),n.attr("size",n.val().length).trigger("apply.daterangepicker",n.data("daterangepicker"))}));